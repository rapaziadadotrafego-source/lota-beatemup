<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Beat'em Up — Demo Avançada (Final Fight style)</title>
  <style>
    :root { --bg:#0f1115; --fg:#e6e6e6; --accent:#ff5a3c; --accent2:#3cc9ff; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:radial-gradient(1200px 800px at 20% 10%, #141824 0%, #0f1115 60%);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    #wrap{display:flex;align-items:center;justify-content:center;height:100%;padding:16px}
    #gameFrame{width:min(100vw, 900px);max-width:900px;aspect-ratio:16/9;border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);position:relative;background:#10131a}
    canvas{width:100%;height:100%;display:block;background:linear-gradient(#1a2030,#121620)}

    .overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:20px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .title{font-size:clamp(22px,3vw,36px);font-weight:800;letter-spacing:.5px;text-align:center}
    .subtitle{opacity:.9;text-align:center}
    .btn{cursor:pointer;user-select:none;padding:12px 18px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05));transition:transform .05s ease,filter .2s ease;font-weight:700}
    .btn.primary{background:linear-gradient(180deg,color-mix(in lab,var(--accent) 70%,#fff 8%),color-mix(in lab,var(--accent) 60%,#000 10%));border-color:color-mix(in lab,var(--accent) 60%,#000 30%);color:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}

    .select-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;width:min(900px,96%)}
    .hero-card{position:relative;overflow:hidden;border-radius:16px;padding:16px;aspect-ratio:3/4;display:flex;flex-direction:column;justify-content:space-between;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08)}
    .hero-name{font-weight:900;font-size:clamp(18px,2.2vw,24px);letter-spacing:.5px}
    .stat{display:flex;align-items:center;gap:8px;font-size:12px;opacity:.9}
    .bar{height:8px;background:rgba(255,255,255,.08);border-radius:999px;width:100%;overflow:hidden}
    .bar>span{display:block;height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;opacity:.9}
    kbd{background:#0c0f16;border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:10px;font-weight:800;box-shadow:inset 0 -2px 0 rgba(255,255,255,.06)}

    /* Touch */
    #touchLayer{position:absolute;inset:0;pointer-events:none}
    .touch{pointer-events:auto;position:absolute;opacity:.75}
    .stick{left:20px;bottom:20px;width:140px;height:140px}
    .stick .base{position:absolute;inset:0;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.18)}
    .stick .nub{position:absolute;width:72px;height:72px;left:34px;top:34px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.25)}
    .abtns{right:20px;bottom:20px;display:flex;gap:14px}
    .abtn{width:72px;height:72px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);display:grid;place-items:center;font-weight:900}
    @media (max-width:720px){.controls{display:none}}

    /* Pause/Options */
    #pauseOverlay{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center}
    #pauseMenu{min-width: min(92%,720px);}
    .opt-row{display:grid;grid-template-columns: 1fr auto;gap:12px;align-items:center}
    .key{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);cursor:pointer;text-align:center;min-width:64px}
    .key.wait{outline:2px solid var(--accent)}
    label.switch{display:flex;align-items:center;gap:10px;cursor:pointer}
    label.switch input{accent-color: var(--accent)}
  </style>
</head>
<body>
  <div id="wrap">
    <div id="gameFrame">
      <canvas id="game" width="1280" height="720"></canvas>

      <!-- Start -->
      <div id="startOverlay" class="overlay">
        <div class="card" style="text-align:center;max-width:760px;">
          <div class="title">Lota Beat ’em Up — Demo Avançada</div>
          <p class="subtitle">Estilo <b>Final Fight</b> com seleção de personagem, combos, agarrão/arremesso, itens, chefe, <b>menu de pausa</b>, <b>áudio</b> e <b>remapeamento de teclas</b>.</p>
          <div class="row" style="margin-top:10px;">
            <div class="btn primary" id="btnStart">Começar</div>
            <div class="btn" id="btnHow">Controles</div>
          </div>
        </div>
      </div>

      <!-- Character Select -->
      <div id="selectOverlay" class="overlay" style="display:none;gap:18px;">
        <div class="title">Seleção de Personagem</div>
        <div class="select-grid">
          <div class="hero-card" data-hero="Adriano">
            <div>
              <div class="hero-name">Adriano</div>
              <div class="subtitle" style="opacity:.8">Equilibrado • Combos consistentes</div>
            </div>
            <div>
              <div class="stat">Força <div class="bar"><span style="width:70%"></span></div></div>
              <div class="stat">Velocidade <div class="bar"><span style="width:65%"></span></div></div>
              <div class="stat">Alcance <div class="bar"><span style="width:60%"></span></div></div>
            </div>
            <div class="btn" style="text-align:center">Escolher</div>
          </div>
          <div class="hero-card" data-hero="Diego">
            <div>
              <div class="hero-name">Diego</div>
              <div class="subtitle" style="opacity:.8">Pancada pesada • Menos mobilidade</div>
            </div>
            <div>
              <div class="stat">Força <div class="bar"><span style="width:90%"></span></div></div>
              <div class="stat">Velocidade <div class="bar"><span style="width:50%"></span></div></div>
              <div class="stat">Alcance <div class="bar"><span style="width:75%"></span></div></div>
            </div>
            <div class="btn" style="text-align:center">Escolher</div>
          </div>
          <div class="hero-card" data-hero="Vinicius">
            <div>
              <div class="hero-name">Vinicius</div>
              <div class="subtitle" style="opacity:.8">Ágil • Golpes rápidos</div>
            </div>
            <div>
              <div class="stat">Força <div class="bar"><span style="width:55%"></span></div></div>
              <div class="stat">Velocidade <div class="bar"><span style="width:90%"></span></div></div>
              <div class="stat">Alcance <div class="bar"><span style="width:65%"></span></div></div>
            </div>
            <div class="btn" style="text-align:center">Escolher</div>
          </div>
        </div>
        <div class="subtitle">PC: <kbd>WASD</kbd>/<kbd>Setas</kbd> mover • <kbd>J</kbd> atacar • <kbd>K</kbd> dash/agarre • <kbd>I</kbd> pular • <kbd>Enter</kbd> pausar. Celular: botões na tela.</div>
        <div><div class="btn" id="btnBackStart">Voltar</div></div>
      </div>

      <!-- Touch Controls -->
      <div id="touchLayer">
        <div class="touch stick" id="stick"><div class="base"></div><div class="nub" id="nub"></div></div>
        <div class="touch abtns">
          <div class="abtn" id="btnA">A</div>
          <div class="abtn" id="btnB">B</div>
          <div class="abtn" id="btnC">C</div>
        </div>
      </div>

      <!-- How -->
      <div id="howOverlay" class="overlay" style="display:none;">
        <div class="card" style="max-width:760px;">
          <div class="title">Controles</div>
          <div class="controls">
            <div><kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> / <kbd>↑</kbd><kbd>←</kbd><kbd>↓</kbd><kbd>→</kbd> Mover</div>
            <div><kbd>J</kbd> Ataque / combo</div>
            <div><kbd>K</kbd> Dash • agarrar próximo • arremessar durante agarre</div>
            <div><kbd>I</kbd> Pulo (esquiva curta)</div>
            <div><kbd>Enter</kbd> Pausar</div>
          </div>
          <div style="text-align:center;margin-top:10px;"><div class="btn" id="btnHowClose">Fechar</div></div>
        </div>
      </div>

      <!-- Pause / Options -->
      <div id="pauseOverlay" class="overlay">
        <div id="pauseMenu" class="card">
          <div class="title">Pausado</div>
          <div class="row" style="justify-content:space-between;gap:18px;align-items:flex-start;flex-wrap:wrap;">
            <div style="flex:1;min-width:260px;">
              <div class="subtitle" style="margin-bottom:8px;">Opções</div>
              <div class="opt-row"><label class="switch"><input id="optMusic" type="checkbox" checked> Música</label></div>
              <div class="opt-row"><label class="switch"><input id="optSfx" type="checkbox" checked> Efeitos sonoros</label></div>
            </div>
            <div style="flex:1;min-width:300px;">
              <div class="subtitle" style="margin-bottom:8px;">Teclas</div>
              <div class="opt-row">Mover ← <div class="key" data-bind="left"></div></div>
              <div class="opt-row">Mover → <div class="key" data-bind="right"></div></div>
              <div class="opt-row">Mover ↑ <div class="key" data-bind="up"></div></div>
              <div class="opt-row">Mover ↓ <div class="key" data-bind="down"></div></div>
              <div class="opt-row">Ataque <div class="key" data-bind="attack"></div></div>
              <div class="opt-row">Dash/Agarrar <div class="key" data-bind="dash"></div></div>
              <div class="opt-row">Pulo <div class="key" data-bind="jump"></div></div>
              <div class="opt-row">Pausar <div class="key" data-bind="pause"></div></div>
            </div>
          </div>
          <div class="row" style="margin-top:14px;">
            <div class="btn" id="btnResume">Continuar</div>
            <div class="btn" id="btnRestart">Reiniciar Fase</div>
            <div class="btn" id="btnExit">Sair p/ Menu</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
  // ===== Persistent settings =====
  const DEFAULT_KEYS = { left:['a','ArrowLeft'], right:['d','ArrowRight'], up:['w','ArrowUp'], down:['s','ArrowDown'], attack:['j'], dash:['k'], jump:['i'], pause:['Enter'] };
  const settings = JSON.parse(localStorage.getItem('lota_settings')||'{}');
  settings.keymap = settings.keymap || DEFAULT_KEYS;
  settings.music = settings.music!==undefined ? settings.music : true;
  settings.sfx = settings.sfx!==undefined ? settings.sfx : true;
  function saveSettings(){ localStorage.setItem('lota_settings', JSON.stringify(settings)); }

  // ===== Core setup =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const startOverlay = document.getElementById('startOverlay');
  const selectOverlay = document.getElementById('selectOverlay');
  const howOverlay = document.getElementById('howOverlay');
  const pauseOverlay = document.getElementById('pauseOverlay');
  const optMusic = document.getElementById('optMusic');
  const optSfx = document.getElementById('optSfx');
  const keysUI = [...document.querySelectorAll('.key')];
  document.getElementById('btnStart').onclick = ()=>{ startOverlay.style.display='none'; selectOverlay.style.display='flex'; };
  document.getElementById('btnHow').onclick = ()=> howOverlay.style.display='flex';
  document.getElementById('btnHowClose').onclick = ()=> howOverlay.style.display='none';
  document.getElementById('btnBackStart').onclick = ()=>{ selectOverlay.style.display='none'; startOverlay.style.display='flex'; };
  document.getElementById('btnResume').onclick = ()=> togglePause(false);
  document.getElementById('btnRestart').onclick = ()=> { restartLevel(); togglePause(false); };
  document.getElementById('btnExit').onclick = ()=> { exitToMenu(); };

  // Touch UI
  const isMobile = matchMedia('(max-width: 900px)').matches;
  const touchLayer = document.getElementById('touchLayer');
  touchLayer.style.display = isMobile ? 'block' : 'none';
  const stick = document.getElementById('stick');
  const nub = document.getElementById('nub');
  const btnA = document.getElementById('btnA'); // attack
  const btnB = document.getElementById('btnB'); // dash / grab / throw
  const btnC = document.getElementById('btnC'); // jump

  // ===== Input =====
  const keys = { left:false,right:false,up:false,down:false, attack:false, dash:false, jump:false };
  function humanKey(k){ return k===' ' ? 'Space' : k; }
  function setKeyLabels(){ keysUI.forEach(el=>{ const b=el.getAttribute('data-bind'); const arr=settings.keymap[b]||[]; el.textContent = (arr[0]||'—'); }); optMusic.checked=settings.music; optSfx.checked=settings.sfx; }
  setKeyLabels();

  // Remap flow
  let waitingBind=null;
  keysUI.forEach(el=>{
    el.addEventListener('click',()=>{ keysUI.forEach(e=>e.classList.remove('wait')); el.classList.add('wait'); waitingBind = el.getAttribute('data-bind'); el.textContent='Pressione…'; });
  });
  addEventListener('keydown', e=>{
    if(waitingBind){ const b=waitingBind; const code=e.key; settings.keymap[b]=[code]; waitingBind=null; keysUI.forEach(e=>e.classList.remove('wait')); setKeyLabels(); saveSettings(); e.preventDefault(); return; }
    handleKD(e,true);
  });
  addEventListener('keyup', e=> handleKD(e,false));

  function matchKey(e, arr){ const k=e.key; return (arr||[]).some(x=>x===k); }
  function handleKD(e,s){
    if(matchKey(e, settings.keymap.left)) keys.left=s;
    if(matchKey(e, settings.keymap.right)) keys.right=s;
    if(matchKey(e, settings.keymap.up)) keys.up=s;
    if(matchKey(e, settings.keymap.down)) keys.down=s;
    if(matchKey(e, settings.keymap.attack)) keys.attack=s;
    if(matchKey(e, settings.keymap.dash)) keys.dash=s;
    if(matchKey(e, settings.keymap.jump)) keys.jump=s;
    if(!s && matchKey(e, settings.keymap.pause)) togglePause();
  }

  optMusic.onchange = ()=>{ settings.music=optMusic.checked; saveSettings(); if(!settings.music) stopMusic(); else startMusic(); };
  optSfx.onchange = ()=>{ settings.sfx=optSfx.checked; saveSettings(); };

  // Touch stick
  let stickTouchId=null, stickCenter=null; const maxStick=40;
  const setMoveFrom = (dx,dy)=>{ keys.left=dx<-10; keys.right=dx>10; keys.up=dy<-10; keys.down=dy>10; };
  stick.addEventListener('touchstart',e=>{ e.preventDefault(); const t=e.changedTouches[0]; stickTouchId=t.identifier; stickCenter={x:t.clientX,y:t.clientY}; nub.style.transform='translate(0,0)'; },{passive:false});
  stick.addEventListener('touchmove',e=>{ if(stickTouchId===null) return; for(const t of e.changedTouches){ if(t.identifier!==stickTouchId) continue; const dx=t.clientX-stickCenter.x, dy=t.clientY-stickCenter.y; const len=Math.hypot(dx,dy)||1; const cl=Math.min(len,maxStick); const nx=dx/len*cl, ny=dy/len*cl; nub.style.transform=`translate(${nx}px,${ny}px)`; setMoveFrom(dx,dy);} },{passive:false});
  const stickEnd=e=>{ for(const t of e.changedTouches){ if(t.identifier===stickTouchId){ stickTouchId=null; keys.left=keys.right=keys.up=keys.down=false; nub.style.transform='translate(0,0)'; } } };
  stick.addEventListener('touchend',stickEnd); stick.addEventListener('touchcancel',stickEnd);
  const bindBtn=(el,prop)=>{ el.addEventListener('touchstart',e=>{e.preventDefault();keys[prop]=true;},{passive:false}); el.addEventListener('touchend',()=>keys[prop]=false); el.addEventListener('touchcancel',()=>keys[prop]=false); };
  bindBtn(btnA,'attack'); bindBtn(btnB,'dash'); bindBtn(btnC,'jump');

  // ===== Helpers =====
  const rand=(a,b)=> a + Math.random()*(b-a);
  const clamp=(v,a,b)=> Math.max(a,Math.min(b,v));

  // Camera / world
  const camera={x:0};
  const world={ left:-200, right:2600, top:440, bottom:640 };

  // ===== Audio (WebAudio, sem arquivos externos) =====
  let actx=null, master=null, sfxGain=null, musicGain=null, musicNode=null; let musicTimer=0; let musicPlaying=false;
  function ensureAudio(){ if(actx) return; actx = new (window.AudioContext||window.webkitAudioContext)(); master=actx.createGain(); master.gain.value=0.9; master.connect(actx.destination); sfxGain=actx.createGain(); sfxGain.gain.value= settings.sfx? 0.9:0; sfxGain.connect(master); musicGain=actx.createGain(); musicGain.gain.value= settings.music? 0.35:0; musicGain.connect(master); }
  function sfx(type){ if(!settings.sfx) return; ensureAudio(); const t=actx.currentTime; if(type==='hit'){ const o=actx.createOscillator(); const g=actx.createGain(); o.type='square'; o.frequency.setValueAtTime(180,t); o.frequency.exponentialRampToValueAtTime(90,t+0.08); g.gain.setValueAtTime(0.8,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.1); o.connect(g).connect(sfxGain); o.start(t); o.stop(t+0.11);} 
    else if(type==='pickup'){ const o=actx.createOscillator(); const g=actx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(660,t); o.frequency.exponentialRampToValueAtTime(1320,t+0.06); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.12); o.connect(g).connect(sfxGain); o.start(t); o.stop(t+0.13);} 
    else if(type==='dash'){ const o=actx.createOscillator(); const g=actx.createGain(); o.type='sawtooth'; o.frequency.setValueAtTime(240,t); o.frequency.exponentialRampToValueAtTime(100,t+0.08); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.12); o.connect(g).connect(sfxGain); o.start(t); o.stop(t+0.13);} 
    else if(type==='bossdie'){ const o=actx.createOscillator(); const g=actx.createGain(); o.type='square'; o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(40,t+0.4); g.gain.setValueAtTime(0.9,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.45); o.connect(g).connect(sfxGain); o.start(t); o.stop(t+0.46);} }
  function startMusic(){ if(musicPlaying||!settings.music) return; ensureAudio(); musicPlaying=true; musicTimer=0; if(musicNode) try{ musicNode.stop(); }catch{}; const o=actx.createOscillator(); const g=actx.createGain(); o.type='triangle'; g.gain.setValueAtTime(0.0, actx.currentTime); g.gain.linearRampToValueAtTime(0.28, actx.currentTime+0.6); o.connect(g).connect(musicGain); o.start(); musicNode=o; (function step(){ if(!musicPlaying) return;
      const t=actx.currentTime; const seq=[220, 261.63, 293.66, 246.94, 220, 174.61, 196, 220]; const f=seq[Math.floor((musicTimer*2)%seq.length)]; musicNode.frequency.setValueAtTime(f, t); musicTimer+=0.12; setTimeout(step, 120); })(); }
  function stopMusic(){ musicPlaying=false; if(musicNode) try{ musicNode.stop(); }catch{}; musicNode=null; }

  // ===== Entities (com "sprites" vetoriais) =====
  function drawSprite(ctx, x,y, dir, tint){
    ctx.save(); ctx.translate(x,y); if(dir<0) ctx.scale(-1,1);
    ctx.fillStyle=tint; ctx.fillRect(-18,-68,36,64);
    ctx.fillStyle='hsl(0 0% 92% / .95)'; ctx.fillRect(-14,-86,28,18);
    ctx.fillStyle='rgba(255,255,255,.14)'; ctx.fillRect(-14,-82,28,6);
    ctx.fillStyle='hsl(0 0% 80%)'; ctx.fillRect(-26,-60,10,22); ctx.fillRect(16,-60,10,22);
    ctx.fillStyle='hsl(0 0% 70%)'; ctx.fillRect(-16,-6,14,10); ctx.fillRect(2,-6,14,10);
    ctx.restore();
  }

  class Actor{ constructor(x,y){ this.x=x; this.y=y; this.dir=1; this.w=46; this.h=72; this.baseSpeed=160; this.speed=this.baseSpeed; this.color='#ccc'; this.team='neutral'; this.hpMax=100; this.hp=this.hpMax; this.dead=false; this.stun=0; this.inv=0; this.state='idle'; this.attackT=0; this.attackCd=0; this.range=38; this.power=10; this.name='NPC'; this.grabbedBy=null; }
    rect(){ return {x:this.x-this.w/2,y:this.y-this.h,w:this.w,h:this.h}; }
    hitbox(){ if(this.attackT>0 && (this.state==='attack'||this.state==='combo')){ const off=this.dir>0? this.w/2 : -this.w/2 - this.range; return {x:this.x+off,y:this.y-this.h*0.8,w:this.range,h:this.h*0.6}; } return null; }
    overlaps(a,b){ return a&&b&&a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y; }
    takeDamage(dmg,from,kbx=16){ if(this.inv>0||this.dead) return; this.hp-=dmg; this.stun=.15; this.inv=.2; this.dir=(this.x<from.x)?-1:1; this.x+=(this.dir)*-kbx; if(this.hp<=0){ this.dead=true; this.state='dead'; } }
    think(dt){ if(this.dead) return; if(this.inv>0) this.inv-=dt; if(this.stun>0){ this.stun-=dt; return; } }
    draw(ctx){ const r=this.rect();
      ctx.fillStyle='rgba(0,0,0,.45)'; ctx.beginPath(); ctx.ellipse(this.x, this.y+6, this.w*0.45, 10, 0, 0, Math.PI*2); ctx.fill();
      drawSprite(ctx, this.x, this.y, this.dir, this.color);
      const bw=56; const bx=this.x-bw/2, by=r.y-14; ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(bx,by,bw,8);
      ctx.fillStyle= this.hp>60? 'hsl(145 60% 45%)' : this.hp>30? 'hsl(45 80% 50%)' : 'hsl(0 80% 55%)';
      ctx.fillRect(bx,by,bw*(this.hp/this.hpMax),8);
      ctx.font='12px sans-serif'; ctx.fillStyle='rgba(255,255,255,.75)'; ctx.textAlign='center'; ctx.fillText(this.name, this.x, by-6);
      if(this.attackT>0 && (this.state==='attack'||this.state==='combo')){ const hb=this.hitbox(); if(hb){ ctx.fillStyle='rgba(255,90,60,.22)'; ctx.fillRect(hb.x,hb.y,hb.w,hb.h); } }
    }
  }

  class Player extends Actor{ constructor(hero){ super(200,560); this.team='player'; this.name=hero.name; this.color=hero.color; this.power=hero.power; this.baseSpeed=hero.speed; this.speed=this.baseSpeed; this.range=hero.range; this.combo=0; this.comboT=0; this.grabT=0; this.hasWeapon=false; this.weaponT=0; this.score=0; }
    think(dt){ if(this.dead) return; if(this.state==='jump'){ this.jumpT-=dt; if(this.jumpT<=0){ this.state='idle'; } }
      this.speed=this.baseSpeed; if(this.weaponT>0){ this.weaponT-=dt; if(this.weaponT<=0){ this.hasWeapon=false; this.range-=12; this.power-=6; } }
      if(keys.dash && this.state!=='grab'){ this.speed*=1.8; }
      let vx=(keys.right?1:0)-(keys.left?1:0); let vy=(keys.down?1:0)-(keys.up?1:0); const len=Math.hypot(vx,vy)||1; vx/=len; vy/=len; this.x+=vx*this.speed*dt; this.y+=vy*this.speed*dt; this.x=clamp(this.x,world.left+60,world.right-60); this.y=clamp(this.y,world.top,world.bottom); if(vx!==0) this.dir=vx>0?1:-1;
      if(keys.jump && this.state!=='jump' && this.state!=='grab'){ this.state='jump'; this.jumpT=.25; this.inv=.18; sfx('dash'); }
      if(this.attackCd>0) this.attackCd-=dt; if(this.attackT>0) this.attackT-=dt; if(this.comboT>0) this.comboT-=dt; else this.combo=0;
      if(this.state==='grab'){ this.grabT-=dt; if(this.grabT<=0) this.releaseGrab(); }
      if(keys.attack && this.state!=='grab' && this.attackCd<=0){ this.combo = (this.comboT>0? (this.combo%3)+1 : 1); this.comboT = .5; this.state = (this.combo<3)? 'combo' : 'attack'; this.attackT = (this.combo===3? .18 : .12); this.attackCd = (this.combo===3? .22 : .18); sfx('hit'); }
      if(keys.dash && this.state!=='grab' && !keys.attack){ const e=closestEnemy(this, 26, 26); if(e){ this.state='grab'; this.grabTarget=e; e.grabbedBy=this; this.grabT=.9; } }
      if(this.state==='grab'){ if(keys.attack){ this.grabTarget.takeDamage(6+this.power*0.4,this,10); this.score+=10; sfx('hit'); this.grabT=.9; }
        if(keys.dash){ const t=this.grabTarget; const dir=this.dir; this.releaseGrab(); t.takeDamage(10+this.power, this, 48); t.x += dir*48; sfx('dash'); }
      }
    }
    releaseGrab(){ if(this.grabTarget){ this.grabTarget.grabbedBy=null; this.grabTarget=null; } this.state='idle'; }
  }

  class Enemy extends Actor{ constructor(x,y,preset){ super(x,y); this.team='enemy'; this.name=preset.name; this.color=preset.color; this.power=preset.power; this.baseSpeed=preset.speed; this.speed=this.baseSpeed; this.range=preset.range; this.hpMax=preset.hp; this.hp=this.hpMax; this.aiTimer=rand(.4,1.2); this.kind=preset.kind||'mob'; }
    think(dt,world,game){ if(this.dead) return; if(this.grabbedBy){ this.x=this.grabbedBy.x+(this.grabbedBy.dir>0?20:-20); this.y=this.grabbedBy.y; return; }
      if(this.inv>0) this.inv-=dt; if(this.stun>0){ this.stun-=dt; return; }
      const p=game.player; if(!p||p.dead) return; const dx=p.x-this.x, dy=p.y-this.y; this.dir=dx>0?1:-1; const dist=Math.hypot(dx,dy);
      if(this.kind==='boss'){ this.aiTimer-=dt; if(dist>120){ this.x+=Math.sign(dx)*this.baseSpeed*dt*1.2; this.y+=Math.sign(dy)*this.baseSpeed*dt*0.8; }
        else if(this.aiTimer<=0){ this.attackT=.16; this.aiTimer=rand(.4,.9); if(Math.random()<.35){ game.fx.push({t:.3,x:this.x,y:this.y,r:70}); for(const a of game.actors){ if(a.team==='player'&&!a.dead && Math.hypot(a.x-this.x,a.y-this.y)<70){ a.takeDamage(14,this,24); } } }
        }
        return; }
      if(dist>80){ const s=this.baseSpeed*(dist>300?1.15:1.0); this.x+=Math.sign(dx)*s*dt; this.y+=Math.sign(dy)*s*dt; }
      else { this.aiTimer-=dt; if(this.aiTimer<=0){ this.attackT=.12; this.aiTimer=rand(.6,1.3); } }
      if(this.attackT>0) this.attackT-=dt; if(this.attackCd>0) this.attackCd-=dt;
    }
  }

  // Items
  class Item{ constructor(x,y,type){ this.x=x; this.y=y; this.type=type; this.w=28; this.h=20; this.t=0; this.dead=false; }
    rect(){ return {x:this.x-this.w/2, y:this.y-this.h, w:this.w, h:this.h}; }
    draw(ctx){ this.t+=0.016; ctx.save(); ctx.globalAlpha=0.95; ctx.fillStyle=this.type==='apple'?'#e74c3c':'#bdc3c7'; const r=this.rect(); ctx.fillRect(r.x,r.y,r.w,r.h); ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(r.x+4,r.y+4,r.w-8,4); ctx.restore(); }
  }

  // Presets
  const ENEMIES={
    THUG:{kind:'mob', name:'Thug', color:'#e67e22', power:8, speed:120, range:34, hp:60},
    BRAWLER:{kind:'mob', name:'Brawler', color:'#9b59b6', power:12, speed:110, range:38, hp:90},
    NINJA:{kind:'mob', name:'Ninja', color:'#16a085', power:10, speed:160, range:42, hp:70},
    BOSS:{kind:'boss', name:'Crusher', color:'#c0392b', power:18, speed:140, range:52, hp:420}
  };
  const HEROES={
    Adriano:{ name:'Adriano', color:'#6ab0ff', power:12, speed:170, range:38 },
    Diego:{ name:'Diego', color:'#ff5a3c', power:18, speed:145, range:46 },
    Vinicius:{ name:'Vinicius', color:'#f0c419', power:10, speed:200, range:36 },
  };

  // ===== Game state =====
  const game={ state:'menu', player:null, actors:[], items:[], paused:false, time:0, wave:0, over:false, fx:[],
    start(heroKey){ this.actors.length=0; this.items.length=0; this.fx.length=0; this.player=new Player(HEROES[heroKey]); this.actors.push(this.player); this.wave=0; this.over=false; this.time=0; spawnWave(); this.state='play'; selectOverlay.style.display='none'; ensureAudio(); startMusic(); },
  };

  function togglePause(force){ if(game.state!=='play' && game.state!=='over') return; if(force===undefined) game.paused=!game.paused; else game.paused=!force?false:true; pauseOverlay.style.display = game.paused? 'flex':'none'; }
  function restartLevel(){ const hero = game.player? game.player.name : 'Adriano'; game.start(hero); }
  function exitToMenu(){ game.state='menu'; game.paused=false; pauseOverlay.style.display='none'; stopMusic(); startOverlay.style.display='flex'; }

  // Character selection
  selectOverlay.addEventListener('click',e=>{ const card=e.target.closest('.hero-card'); if(!card) return; const key=card.dataset.hero; game.start(key); });

  // Spawning
  function spawnWave(){ game.wave++; const sy=[500,560,620]; const types=[ENEMIES.THUG, ENEMIES.BRAWLER, ENEMIES.NINJA]; const baseX=(game.player.x+260);
    for(let i=0;i<3+game.wave;i++){ const t=types[i%types.length]; game.actors.push(new Enemy(rand(baseX, baseX+520), sy[i%sy.length], t)); }
  }
  function spawnBoss(){ const y=560; const x=game.player.x+420; game.actors.push(new Enemy(x,y,ENEMIES.BOSS)); }

  // Combat & interactions
  function closestEnemy(p, dx=40, dy=40){ let best=null, bd=1e9; for(const a of game.actors){ if(a.team==='enemy' && !a.dead){ const d=Math.max(Math.abs(a.x-p.x)-dx, Math.abs(a.y-p.y)-dy); if(d<bd){ bd=d; best=a; } } } return bd<24? best : null; }

  function resolveCombat(){
    for(const a of game.actors){ if(a.dead) continue; const hb=a.hitbox?.(); if(!hb) continue; for(const b of game.actors){ if(a===b||a.team===b.team||b.dead) continue; if(a.overlaps(hb,b.rect())){ const depth=Math.abs(a.y-b.y); if(depth<42){ const pow=a.power + (a.team==='player'? (game.player.combo===3?6:0) : 0); b.takeDamage(pow, a, a.team==='player'&&game.player.combo===3?24:16); if(a.team==='player'){ game.player.score+=15; sfx('hit'); } } } } }
    for(const it of game.items){ if(it.dead) continue; const r=it.rect(); const pr=game.player.rect(); if(game.player.overlaps(r,pr)){ if(it.type==='apple'){ game.player.hp=Math.min(game.player.hpMax, game.player.hp+35); } else if(it.type==='pipe'){ if(!game.player.hasWeapon){ game.player.hasWeapon=true; game.player.weaponT=18; game.player.range+=12; game.player.power+=6; } else { game.player.weaponT+=6; } } it.dead=true; sfx('pickup'); } }
  }

  function cleanupAndProgress(){ game.actors=game.actors.filter(a=>!a._remove); game.items=game.items.filter(i=>!i.dead);
    const enemiesAlive=game.actors.some(a=>a.team==='enemy'&&!a.dead&&!a._remove);
    const bossAlive=game.actors.some(a=>a.team==='enemy' && a.kind==='boss' && !a.dead);
    if(!enemiesAlive && !bossAlive){ if(game.wave<2){ spawnWave(); } else if(!bossAlive && !game.over){ spawnBoss(); }
    }
    for(const a of game.actors){ if(a.dead && !a.dropChecked){ a.dropChecked=true; if(a.kind==='boss'){ sfx('bossdie'); } if(Math.random()<0.25){ const type=Math.random()<0.6?'apple':'pipe'; game.items.push(new Item(a.x, a.y-8, type)); } setTimeout(()=>{ a._remove=true; }, 200); } }
    if(!bossAlive && game.wave>=2){ const allGone=!game.actors.some(a=>a.team==='enemy' && !a._remove); if(allGone && !game.over){ game.over=true; game.state='over'; }
    }
  }

  // ===== Rendering =====
  function drawBG(){ const grd=ctx.createLinearGradient(0,0,0,H); grd.addColorStop(0,'#1b2335'); grd.addColorStop(.5,'#1a2030'); grd.addColorStop(1,'#141924'); ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='rgba(255,255,255,.06)'; for(let x=-((camera.x%160)+160); x<W+160; x+=160){ ctx.fillRect(x, world.bottom+10, 120, 6); }
    ctx.fillStyle='rgba(255,255,255,.07)'; ctx.fillRect(0, world.bottom+24, W, 40);
    ctx.save(); ctx.translate(-camera.x*0.3,0); for(let i=0;i<12;i++){ const bx=i*320; const by=260; const bw=240; const bh=260+(i%3)*40; ctx.fillStyle='rgba(255,255,255,.05)'; ctx.fillRect(bx,by,bw,bh); ctx.fillStyle='rgba(255,255,255,.04)'; for(let w=0;w<6;w++) for(let h=0;h<4;h++) ctx.fillRect(bx+24+w*32, by+24+h*32, 18, 18);} ctx.restore(); }

  function drawHUD(){ const p=game.player; if(!p) return; const pad=18,bw=280,bh=16; ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(pad,pad,bw,bh); ctx.fillStyle='#fff'; ctx.font='16px sans-serif'; ctx.fillText(p.name, pad, pad-6); const ratio=p.hp/p.hpMax; ctx.fillStyle= ratio>0.6? '#2ecc71' : ratio>0.3? '#f1c40f' : '#e74c3c'; ctx.fillRect(pad,pad,bw*ratio,bh);
    ctx.fillStyle='rgba(255,255,255,.7)'; ctx.textAlign='right'; ctx.fillText('Wave '+game.wave+(game.over?' — Chefe derrotado!':''), W-20, 26); ctx.fillText('Score '+p.score, W-20, 46); ctx.textAlign='left'; }

  function drawFX(){ for(const f of game.fx){ f.t-=0.016; ctx.save(); ctx.globalAlpha=Math.max(0,f.t*2); ctx.beginPath(); ctx.arc(f.x-camera.x,f.y, f.r,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=4; ctx.stroke(); ctx.restore(); } game.fx=game.fx.filter(f=>f.t>0); }

  // ===== Loop =====
  let last=performance.now();
  function loop(now){ const dt=Math.min(0.033,(now-last)/1000); last=now; if(!game.paused){ update(dt); render(); } requestAnimationFrame(loop); }

  function update(dt){ if(game.state!=='play') return; camera.x=clamp(game.player.x - W*0.35, 0, world.right - W*0.5);
    for(const a of game.actors){ a.think(dt,world,game); }
    resolveCombat();
    cleanupAndProgress();
  }

  function render(){ drawBG(); if(game.state==='play'||game.state==='over'){ ctx.save(); ctx.translate(-camera.x,0); const vis=[...game.actors].sort((a,b)=>a.y-b.y); for(const a of vis){ a.draw(ctx); } for(const it of game.items){ it.draw(ctx); } drawFX(); ctx.restore(); drawHUD(); if(game.state==='over'){ ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.font='28px sans-serif'; ctx.textAlign='center'; ctx.fillText('DEMO FINALIZADA — Chefe derrotado! Obrigado por jogar!', W/2, H/2); ctx.textAlign='left'; } }

  requestAnimationFrame(loop);
  </script>
</body>
</html>
